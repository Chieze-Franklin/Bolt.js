{{#if error}}
<div class="container-xs-height full-height">
  <div class="row-xs-height">
    <div class="col-xs-height col-middle">
      <div class="error-container text-center">
        <!-- <h1 class="error-number">{{error.title}}</h1> -->
        <h2 class="semi-bold">{{error.title}}</h2>
        <p>
            {{error.message}}
        </p>
        <a href="/home" class="btn btn-block btn-info btn-cons m-b-10">Go Home</a>
      </div>
    </div>
  </div>
</div>
{{else}}
<div class="register-container full-height">
  <div id="rootwizard">
      <div class="tab-content">
          <div class="tab-pane active slide-left" id="begin">
              <div class="row row-same-height">
                    <div class="p-l-50 m-l-20 p-r-50 m-r-20 p-t-50 m-t-30 sm-p-l-15 sm-p-r-15 sm-p-t-40">
                      <!-- START Login Form -->
                      <form id="form-register" enctype="multipart/form-data">
                        <div class="row">
                          <div class="col-sm-12">
                            <h2 class="semi-bold">@{{user.name}}</h2>
                          </div>
                        </div>
                        
                        {{#if editable}}
                        <div class="row">
                          <div class="col-xs-12">
                            <div class="panel panel-default">
                              <div class="panel-body">
                                <img id="imgPrev" class="img img-responsive" width="200" height="200" src="{{user.displayPic}}">
                                <div class="progress">
                                  <div class="progress-bar" role="progressbar"></div>
                                </div>
                                <button class="btn btn-lg pick-btn" type="button">Change Display Pic</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <input type="file" name="dp" id="dp" class="form-control">
                        {{else}}
                        <div class="row">
                          <div class="col-xs-12">
                            <div class="panel panel-default">
                              <div class="panel-body">
                                <img id="imgPrev" class="img img-responsive" width="200" height="200" src="{{user.displayPic}}">
                              </div>
                            </div>
                          </div>
                        </div>
                        {{/if}}

                        {{#if editable}}
                        <div class="row">
                          <div class="col-sm-12">
                            <a class="btn btn-info btn-cons m-t-10" id="change_pwd" data-toggle="tab" href="#tab_change_pwd">
                              <span>Change password</span>
                            </a>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-sm-12">
                            <a class="btn btn-info btn-cons m-t-10" id="reset_pwd">I cannot remember my password</a>
                          </div>
                        </div>
                        {{/if}}

                        <hr />

                        <div class="row">
                          <div class="col-sm-12">
                            {{#if editable}}
                            <div class="form-group form-group-default">
                              <label>Display name</label>
                              <input type="text" name="dn" id="dn" value="{{user.displayName}}" class="form-control">
                            </div>
                            {{else}}
                            <h5 class="semi-bold">{{user.displayName}}</h5>
                            {{/if}}
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-sm-12">
                            {{#if editable}}
                            <div class="form-group form-group-default">
                              <label>Email</label>
                              <input type="email" name="email" id="email" value="{{user.email}}" class="form-control">
                            </div>
                            {{else}}
                            <h5 class="semi-bold"><i class="fa fa-envelope"></i> {{user.email}}</h5>
                            {{/if}}
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-sm-12">
                            {{#if editable}}
                            <div class="form-group form-group-default">
                              <label>Phone</label>
                              <input type="tel" name="phone" id="phone" value="{{user.phone}}" class="form-control">
                            </div>
                            {{else}}
                            <h5 class="semi-bold"><i class="fa fa-phone"></i> {{user.phone}}</h5>
                            {{/if}}
                          </div>
                        </div>
                      </form>
                      <!--END Login Form-->

                      {{#if editable}}
                      <button class="btn btn-primary btn-cons m-t-10" type="submit" id="submit" name="submit">Save</button>
                      <div class="row">
                        <div class="col-sm-12"><br /></div>
                      </div>
                      {{/if}}
                    </div>
              </div>
            </div>
            {{#if editable}}
            <div class="tab-pane slide-left" id="tab_change_pwd">
              <div class="p-l-50 m-l-20 p-r-50 m-r-20 p-t-50 m-t-30 sm-p-l-15 sm-p-r-15 sm-p-t-40">
                <div class="row">
                  <div class="col-sm-12">
                    <div class="form-group form-group-default">
                      <label>Old Password</label>
                      <input type="password" name="password" id="password" placeholder="enter old password" class="form-control" required>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-12">
                    <div class="form-group form-group-default">
                      <label>New Password</label>
                      <input type="password" name="new_password" id="new_password" placeholder="enter new password" class="form-control" required>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-12">
                    <div class="form-group form-group-default">
                      <label>Confirm New Password</label>
                      <input type="password" name="confirm_new_password" id="confirm_new_password" placeholder="enter new password again" class="form-control" required>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-4">
                    <a class="btn btn-primary btn-cons m-t-10" data-toggle="tab" href="#begin">
                      <span><i class="fa fa-arrow-left"></i> Back</span>
                    </a>
                  </div>
                  <div class="col-sm-4">
                    <a class="btn btn-primary btn-cons m-t-10" id="save_pwd" data-toggle="tab">
                      <span>Save Password</span>
                    </a>
                  </div>
                  <div class="col-sm-4"></div>
                </div>
              </div>
            </div>
            {{/if}}
      </div>
    </div>
  </div>
  {{/if}}
<script>
$(document).ready(function(){
  $('#form-register').validate()

  function prevImage(input) {
      if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function (e) {console.log(e.target.result);
              $('#imgPrev').attr('src', e.target.result);
          }

          reader.readAsDataURL(input.files[0]);
      }
  }

  $('.pick-btn').on('click', function (){
      $('#dp').click();
      $('.progress-bar').text('0%');
      $('.progress-bar').width('0%');
  });

  // create a FormData object which will be sent as the data payload in the
  // AJAX request
  var formData = new FormData();

  $('#dp').on('change', function(){
    var files = $(this).get(0).files;

    if (files.length > 0){
      // loop through all the selected files and add them to the formData object
      for (var i = 0; i < files.length; i++) {
        var file = files[i];

        // add the files to formData object for the data payload
        formData.append('dp', file, file.name);

        //preview the image
        prevImage(this);
      }
    }
  });
//////////////////////////////
  $("#submit").click(function(){
      var displayname = $("#dn").val();
      var email = $("#email").val();
      var phone = $("#phone").val();

      var user = {
        displayName: displayname,
        email: email,
        phone: phone
      };

      //upload picture
      $.ajax({
        url: '/public/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false, //'multipart/form-data',
        beforeSend: function(xhr) {
          xhr.setRequestHeader('X-Bolt-App-Token', '{{token}}');
        },
        success: function(response){
          if(response.code === 0) {
            if (response.body.length > 0) user.displayPic = response.body[0].url;

            $.ajax({
              url: '/api/users/{{user.name}}',
              type: 'PUT',
              data: user,
              headers: {'X-Bolt-App-Token': '{{token}}'},
              success: function(response1){
                if(response1.code == 0){
                  swal({
                    title: "User Updated!",
                    text: displayname + " has been updated!",
                    type: "success",
                    showCancelButton: false,
                    closeOnConfirm: true
                  }, function(isConfirm){
                    if (isConfirm) {
                      window.location.href = "/@{{user.name}}";
                    }
                  });
                }
                else {
                  sweetAlert(response1.errorUserTitle, response1.errorUserMessage, "error");
                }
              },
              error: function(xhr1, status1, err1){
                alert(xhr1.responseText);
              }
            });
          }
          else {
              swal(response.errorUserTitle, response.errorUserMessage, "error");
          }
        },
        error: function(xhr, status, err){
          alert(xhr.responseText);
        },
        xhr: function() {
          // create an XMLHttpRequest
          var xhr = new XMLHttpRequest();

          // listen to the 'progress' event
          xhr.upload.addEventListener('progress', function(evt) {

            if (evt.lengthComputable) {
              // calculate the percentage of upload completed
              var percentComplete = evt.loaded / evt.total;
              percentComplete = parseInt(percentComplete * 100);

              // update the Bootstrap progress bar with the new percentage
              $('.progress-bar').text(percentComplete + '%');
              $('.progress-bar').width(percentComplete + '%');

              // once the upload reaches 100%, set the progress bar text to done
              if (percentComplete === 100) {
                $('.progress-bar').html('Done');
              }

            }

          }, false);

          return xhr;
        }
      });
  });

  $("#save_pwd").click(function(){
    var password = $("#password").val();
    var new_password = $("#new_password").val();
    var con_new_password = $("#confirm_new_password").val();

    if (!password || !new_password) {
      sweetAlert("Error", "Password or new password not supplied!", "error");
      return;
    }

    if (new_password !== con_new_password) {
      sweetAlert("Error", "New password and confirmation password do not match!", "error");
      return;
    }

    $.ajax({
      url: '/api/users/change-password',
      type: 'POST',
      data: {password: password, newPassword: new_password},
      headers: {'X-Bolt-App-Token': '{{token}}', 'X-Bolt-User-Name': '{{user.name}}'},
      success: function(response1){
        if(response1.code == 0){
          swal({
            title: "Password Updated!",
            text: "Password for {{user.displayName}} has been updated!",
            type: "success",
            showCancelButton: false,
            closeOnConfirm: true
          }, function(isConfirm){
            if (isConfirm) {
              window.location.href = "/@{{user.name}}";
            }
          });
        }
        else {
          sweetAlert(response1.errorUserTitle, response1.errorUserMessage, "error");
        }
      },
      error: function(xhr1, status1, err1){
        alert(xhr1.responseText);
      }
    });
  });
});
</script>