<div class="login-wrapper ">
  <!-- START Login Background Pic Wrapper-->
  <div class="bg-pic">
    <!-- START Background Pic-->
    <img src="public/bolt/native/img/setup-wallpaper.jpg" alt="" class="lazy">
    <!-- END Background Pic-->
    <!-- START Background Caption-->
    <div class="bg-caption pull-bottom sm-pull-bottom text-white p-l-20 m-b-20">
      <h2 class="semi-bold text-white">
			Setup your Bolt runtime environment!</h2>
      <p class="small">
        All work copyright of respective owners, otherwise Â© 2016 Bolt.
      </p>
    </div>
    <!-- END Background Caption-->
  </div>
  <!-- END Login Background Pic Wrapper-->
  <!-- START Login Right Container-->
  <div class="login-container bg-white">
    <div id="rootwizard" class="m-t-50">
        <!-- Nav tabs
      <ul class="nav nav-tabs nav-tabs-separator nav-stack-sm">
        <li class="active">
          <a data-toggle="tab" href="#tab1"></a>
        </li>
      </ul> -->
      <!-- Tab panes -->
      <div class="tab-content">
          <div class="tab-pane active slide-left" id="begin">
              <div class="row row-same-height">
                    <div class="p-l-50 m-l-20 p-r-50 m-r-20 p-t-50 m-t-30 sm-p-l-15 sm-p-r-15 sm-p-t-40">
                      <img src="public/bolt/native/img/logo.png" alt="logo" width="78" height="22">
                      <p class="p-t-35">You are being registered as an admin</p>
                      <!-- START Login Form -->
                      <div>
                        <!-- START Form Control-->
                        <div class="form-group form-group-default">
                          <label>Name</label>
                          <div class="controls">
                            <input type="text" name="displayname" id="displayname" placeholder="Display Name" class="form-control" required>
                          </div>
                        </div>
                        <!-- END Form Control-->
                        <!-- START Form Control-->
                        <div class="form-group form-group-default">
                          <label>Login</label>
                          <div class="controls">
                            <input type="text" name="username" id="username" placeholder="User Name" class="form-control" required>
                          </div>
                        </div>
                        <!-- END Form Control-->
                        <!-- START Form Control-->
                        <div class="form-group form-group-default">
                          <label>Password</label>
                          <div class="controls">
                            <input type="password" class="form-control" name="password" id="password" placeholder="Credentials" required>
                          </div>
                        </div>
                        <!-- END Form Control-->
                        <!-- START Form Control-->
                        <div class="form-group form-group-default">
                          <label>Confirm Password</label>
                          <div class="controls">
                            <input type="password" class="form-control" name="password" id="confirm_password" placeholder="Credentials" required>
                          </div>
                        </div>
                        <button class="btn btn-primary btn-cons m-t-10" value="submit" id="submit">Sign in</button>
                        <ul class="pager wizard">
                            <li>
                            {{#if steps}}
                              <a class="btn btn-default btn-cons pull-right hidden" id="setup" data-toggle="tab" href="#tab0">
                                <span>Setup <i class="fa fa-arrow-right"></i></span>
                              </a>
                              {{else}}
                              <a class="btn btn-default btn-cons pull-right hidden" id="setup" data-toggle="tab" href="#end">
                                <span>Setup <i class="fa fa-arrow-right"></i></span>
                              </a>
                            {{/if}}
                            </li>
                          </ul>
                      </div>
                      <!--END Login Form-->
                    </div>
              </div>
            </div>
            {{#each steps}}
            <div class="tab-pane slide-left" id="tab{{@index}}">
                <div class="row row-same-height">
                    <div class="p-l-50 m-l-20 p-r-50 m-r-20 p-t-50 m-t-30 sm-p-l-15 sm-p-r-15 sm-p-t-40">
                        <h3>{{title}}</h3>
                        <p>{{message}}</p>
                        <ul class="pager wizard">
                            <li class="next">
                              <button class="btn btn-primary btn-cons pull-right" type="button" 
                              onclick="performRequests({{@index}});">
                                <span>OK</span>
                              </button>
                            </li>
                            <li class="previous">
                            {{#if next}}
                              <a id="skip{{@index}}" class="btn btn-default btn-cons pull-right" data-toggle="tab" href="#tab{{next}}">
                                <span>Skip</span>
                              </a>
                              {{else}}
                              <a id="skip{{@index}}" class="btn btn-default btn-cons pull-right" data-toggle="tab" href="#end">
                                <span>Skip</span>
                              </a>
                            {{/if}}
                            </li>
                          </ul>
                    </div>
                </div>
            </div>
            {{/each}}
            <div class="tab-pane slide-left" id="end">
                <div class="row row-same-height">
                    <div class="p-l-50 m-l-20 p-r-50 m-r-20 p-t-50 m-t-30 sm-p-l-15 sm-p-r-15 sm-p-t-40">
                        <h1>Done</h1>
                        <ul class="pager wizard">
                            <li>
                              <button class="btn btn-primary btn-cons m-t-10" id="proceed">Proceed</button>
                            </li>
                          </ul>
                    </div>
                </div>
            </div>
      </div>
    </div>
  </div>
  <!-- END Login Right Container-->
</div>
<script>
var performRequests = function(index){ 
    var steps = {{{json steps}}};
    var step = steps[index];
    var requestsSync = step.requestsSync;
    if(requestsSync){
      var runRequest = function(index){
        if(index < requestsSync.length) {
          var req = requestsSync[index];    
          $.ajax({
            url: "{{protocol}}://{{host}}:{{port}}/" + req.endpoint,
            data: req.body,
            type: req.method,
            //processData: false,
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-Bolt-Req-Id', '{{reqid}}');
            },
            success: function(response, status, xhr){
              runRequest(++index);
            },
            error: function(xhr, status, err){
              runRequest(++index);
            }
          });
        }
      }
      runRequest(0);
    }
    var requests = step.requests;
    if(requests) {
      requests.forEach(function(req){  
        $.ajax({
          url: "{{protocol}}://{{host}}:{{port}}/" + req.endpoint,
          data: req.body,
          type: req.method,
          //processData: false,
          beforeSend: function(xhr) {
            xhr.setRequestHeader('X-Bolt-Req-Id', '{{reqid}}');
          },
          success: function(response, status, xhr){},
          error: function(xhr, status, err){}
        });
      });
    }
    $("#skip" + index)[0].click();
}
$(function()
{
    //$('#form-login').validate()
})
$(document).ready(function(){
    var displayname, username, password, con_password;
    $("#submit").click(function(){
        displayname=$("#displayname").val();
        username=$("#username").val();
        password=$("#password").val();
        con_password=$("#confirm_password").val();
        /*
        * Perform some validation here.
        */

        //first, add the user
        $.ajax({
        	url: "{{protocol}}://{{host}}:{{port}}/api/users",
        	data: { name: username, password: password, displayName: displayname },
        	type: "POST",
        	beforeSend: function(xhr) {
        		xhr.setRequestHeader('X-Bolt-Req-Id', '{{reqid}}');
        	},
        	success: function(response, status, xhr){
        		if(response.code == 0){ 
        			//second, create an admin role
        			$.ajax({
        				url: "{{protocol}}://{{host}}:{{port}}/api/roles",
        				data: { name: "admin", isAdmin: true, displayName: "Administrator", description: "Administrator" },
        				type: "POST",
        				headers: {'X-Bolt-Req-Id': '{{reqid}}'},
        				success: function(response2, status2, xhr2){
        					if(response2.code == 0){ 
        						//third, associate user and role
        						$.ajax({
        							url: "{{protocol}}://{{host}}:{{port}}/api/user-roles",
        							data: { user: response.body.name, role: response2.body.name },
        							type: "POST",
        							headers: {'X-Bolt-Req-Id': '{{reqid}}'},
        							success: function(response3, status3, xhr3){
        								if(response3.code == 0){ 
        									//fourth, log user in
        									$.ajax({
        										url: "{{protocol}}://{{host}}:{{port}}/api/users/login",
        										data: { name: username, password: password },
        										type: "POST",
        										headers: {'X-Bolt-Req-Id': '{{reqid}}'},
        										success: function(response4, status4, xhr4){
        											if(response4.code == 0){ 
                                  //TODO: success dialog
                                  $("#setup")[0].click();
        											}
        											else {
        												//TODO: error
        												console.log("/user/login");console.log(response4)
        											}
        										},
        										error: function(xhr4, status4, err4){}
        									});
        								}
        								else {
        									//TODO: error
        									console.log("/user-role");console.log(response3);
        								}
        							},
        							error: function(xhr3, status3, err3){}
        						});
        					}
        					else {
        						//TODO: error
        						console.log("/role");console.log(response2);
        					}
        				},
        				error: function(xhr2, status2, err2){}
        			});
        		}
        		else {
        			//TODO: error
        			console.log("/user");console.log(response);
        		}
        	},
        	error: function(xhr, status, err){}
        });
  	});

    $("#proceed").click(function(){
        window.location.href="{{protocol}}://{{host}}:{{port}}/{{redirect}}";
    });
  });
</script>